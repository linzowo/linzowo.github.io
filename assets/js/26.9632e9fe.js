(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{572:function(t,s,a){"use strict";a.r(s);var r=a(7),e=Object(r.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"第一次使用nginx反向代理的大坑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一次使用nginx反向代理的大坑"}},[t._v("#")]),t._v(" 第一次使用nginx反向代理的大坑")]),t._v(" "),a("h2",{attrs:{id:"项目需求："}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目需求："}},[t._v("#")]),t._v(" 项目需求：")]),t._v(" "),a("p",[t._v("通过webpack-dev-server中间件代理访问配置在nginx上的反向代理服务端口，从而实现跨域请求资源。")]),t._v(" "),a("h2",{attrs:{id:"最终实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最终实现"}},[t._v("#")]),t._v(" 最终实现")]),t._v(" "),a("p",[a("strong",[t._v("webpack配置")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("devServer")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("proxy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代理配置")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'/v1'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("target")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8001"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代理服务器地址，nginx会监听此接口下的请求，并代理请求真正的网址")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("pathRewrite")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'^/v1'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("nginx配置")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resolver")]),t._v(" 8.8.8.8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#配置域名进行访问的时候，需要配置此项目，否则会报502错误")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8001")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#代理服务器端口")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#域名")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#路由规则 代理所有请求到https://u.y.qq.com/cgi-bin/musicu.fcg")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v("  https://u.y.qq.com/cgi-bin/musicu.fcg?"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$query_string")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   \t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"实现过程中的各种坑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现过程中的各种坑"}},[t._v("#")]),t._v(" 实现过程中的各种坑")]),t._v(" "),a("p",[t._v("为了自己以后不在这种地方犯迷糊，也希望能给大家一些帮助，所以总结一下我遇到的各种坑")]),t._v(" "),a("h3",{attrs:{id:"_1-如何保证webpack代理到正确的路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-如何保证webpack代理到正确的路径"}},[t._v("#")]),t._v(" 1. 如何保证webpack代理到正确的路径")]),t._v(" "),a("p",[t._v("首先我们要清除webpack-dev-server的转发机制，就以我上面代码中的设置")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("proxy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代理配置")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'/v1'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("target")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8001"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这个代理的结果就是")]),t._v(" "),a("p",[a("strong",[t._v("访问"),a("code",[t._v("http://localhost:8000/v1")]),t._v(" → 代理监听到这个请求 → 转发到"),a("code",[t._v("http://localhost:8001/v1")])])]),t._v(" "),a("p",[t._v("可以看到这层代理只是更改了域名"),a("code",[t._v("http://localhost:8000")]),t._v("部分后面的路径完全照搬，所以在nginx的代理规则中我们一定要清楚的认识到从webpack-dev-server转发过来地url是怎么样的。")]),t._v(" "),a("p",[a("strong",[t._v("另外一定要注意的是,这个监听的是以"),a("code",[t._v("/v1")]),t._v("开头的所有url,不管你是"),a("code",[t._v("/v1aa")]),t._v("还是"),a("code",[t._v("/v1/aa")]),t._v(",只要是以"),a("code",[t._v("/v1")]),t._v("开始就行,")])]),t._v(" "),a("p",[a("strong",[t._v("不要使用正则,例如"),a("code",[t._v("/v1/*")]),t._v(",这个匹配的是以 "),a("code",[t._v("/v1/*xxx")]),t._v("而不是"),a("code",[t._v("/v1/xxx")]),t._v("都是血泪教训,")])]),t._v(" "),a("p",[a("strong",[t._v("另外我还不清楚这个配置能否使用正则,知道的朋友可以告诉我一下.")])]),t._v(" "),a("p",[a("strong",[t._v("如果要取消后面的部分路径怎么办呢")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("proxy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 代理配置")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'/v1'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("target")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8001"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("pathRewrite")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'^/v1'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("通过"),a("code",[t._v("pathRewrite: {'^/v1' : ''}")]),t._v("路径重写方法，将路径中的部分内容重写为想要的内容，具体使用方法请自行百度。")]),t._v(" "),a("h3",{attrs:{id:"_2-如何保证nginx正确转发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-如何保证nginx正确转发"}},[t._v("#")]),t._v(" 2. 如何保证nginx正确转发")]),t._v(" "),a("p",[t._v("现在我们知道了，向nginx服务器发起的请求地址为"),a("code",[t._v("http://localhost:8001/v1")]),t._v(",现在就可以在nginx配置中着手处理请求了。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("resolver")]),t._v(" 8.8.8.8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#配置域名进行访问的时候，需要配置此项目，否则会报502错误")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8001")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#因为请求的是8001端口，所以我们监听这个端口")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  localhost")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#域名的作用同端口")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#路由规则 代理所有请求到https://u.y.qq.com/cgi-bin/musicu.fcg")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v("  https://u.y.qq.com/cgi-bin/musicu.fcg?"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$query_string")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   \t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("整个匹配机制的关键就在于")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" \n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v("  https://u.y.qq.com/cgi-bin/musicu.fcg?"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$query_string")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这个部分中的"),a("code",[t._v("location")]),t._v("的意思就是url中除去域名的部分，以"),a("code",[t._v("http://localhost:8001/v1")]),t._v("为例")]),t._v(" "),a("p",[a("code",[t._v("location")]),t._v("就是"),a("code",[t._v("/v1")])]),t._v(" "),a("p",[t._v("而"),a("code",[t._v("location /")]),t._v("中的"),a("code",[t._v("/")]),t._v("就是匹配的关键，具体见下")]),t._v(" "),a("blockquote",[a("p",[t._v("=    开头表示精确匹配")]),t._v(" "),a("p",[t._v("^~    开头表示url以某个常规字符串开头，理解为匹配url路径即可，nginx不对url做编码，因此请求为/static/20%/aa,可以被规则 ^$ /static/ /aa 匹配到")]),t._v(" "),a("p",[t._v("~    区分大小写的正则匹配")]),t._v(" "),a("p",[t._v("~*    不区分大小写的正则匹配")]),t._v(" "),a("p",[t._v("!~ !~*   区分大小写不匹配及不区分大小写不匹配的正则")]),t._v(" "),a("p",[t._v("/    通用匹配，任何请求都会匹配到")])]),t._v(" "),a("p",[t._v("同时这个匹配机制是由顺序的,顺序为")]),t._v(" "),a("blockquote",[a("p",[t._v("多个location配置的情况下匹配顺序")]),t._v(" "),a("p",[t._v("为首先匹配 =")]),t._v(" "),a("p",[t._v("其次匹配 ^~")]),t._v(" "),a("p",[t._v("其次是按文件中的顺序的正则匹配，")]),t._v(" "),a("p",[t._v("最后是交给 / 通用匹配。")]),t._v(" "),a("p",[t._v("当匹配成功的时候，停止匹配，按当前匹配规则处理请求。")])]),t._v(" "),a("p",[t._v("因为我的当前项目暂时没有其他转发需求,所以我配置的所有请求都转发到同一个地址.")]),t._v(" "),a("h3",{attrs:{id:"_3-nginx一些内置参数的含义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-nginx一些内置参数的含义"}},[t._v("#")]),t._v(" 3. nginx一些内置参数的含义")]),t._v(" "),a("blockquote",[a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$args ： #这个变量等于请求行中的参数，同$query_string\n$content_length ： 请求头中的Content-length字段。\n$content_type ： 请求头中的Content-Type字段。\n$document_root ： 当前请求在root指令中指定的值。\n$host ： 请求主机头字段，否则为服务器名称。\n$http_user_agent ： 客户端agent信息\n$http_cookie ： 客户端cookie信息\n$limit_rate ： 这个变量可以限制连接速率。\n$status  请求状态\n$body_bytes_sent 发送字节\n$request_method ： 客户端请求的动作，通常为GET或POST。\n$remote_addr ： 客户端的IP地址。\n$remote_port ： 客户端的端口。\n$remote_user ： 已经经过Auth Basic Module验证的用户名。\n$request_filename ： 当前请求的文件路径，由root或alias指令与URI请求生成。\n$scheme ： HTTP方法（如http，https）。\n$server_protocol ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。\n$server_addr ： 服务器地址，在完成一次系统调用后可以确定这个值。\n$server_name ： 服务器名称。\n$server_port ： 请求到达服务器的端口号。\n$request_uri ： 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。\n$uri ： 不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。\n$document_uri ： 与$uri相同。\n")])])])]),t._v(" "),a("p",[t._v("其中"),a("code",[t._v("$args")]),t._v("和"),a("code",[t._v("$query_string")]),t._v("的内容是一样的,都是url中的参数字符串.假设一个url为"),a("code",[t._v("http://localhost:8000/v1/?a=1&b=2&c=3")]),t._v("则")]),t._v(" "),a("p",[a("code",[t._v("$args")]),t._v("的值为"),a("code",[t._v("a=1&b=2&c=3")])]),t._v(" "),a("p",[a("strong",[t._v("这里需要注意这个部分是不带"),a("code",[t._v("?")]),t._v("的所以在转发拼接参数的时候一定要带上"),a("code",[t._v("?")])])]),t._v(" "),a("p",[t._v("例如:"),a("code",[t._v("proxy_pass https://u.y.qq.com/cgi-bin/musicu.fcg?$query_string;")])]),t._v(" "),a("blockquote",[a("p",[t._v("最后：希望以后我不在为这个问题苦恼大家也一样.最后祝大家编码愉快，头发茂盛。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);